<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Huang Pengxin">
<meta name="dcterms.date" content="2025-11-15">

<title>Take-home Exercise 2: Spatio-temporal Analysis of Bus Passenger Flows Using Hexagonal Tessellation – ISSS626 Portfolio — HUANG PENGXIN</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ISSS626 Portfolio — HUANG PENGXIN</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hands-on" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Hands-on</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-hands-on">    
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex01/ex01a.html">
 <span class="dropdown-text">Ex01a · Geospatial Wrangling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex01/ex01b.html">
 <span class="dropdown-text">Ex01b · Choropleth Mapping</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex02/ex02a.html">
 <span class="dropdown-text">Ex02a · Child Care Choropleth</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex02/ex02b.html">
 <span class="dropdown-text">Ex02b · Spatial Weights &amp; Autocorrelation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex03/ex03.html">
 <span class="dropdown-text">Ex03a · ST Point Patterns</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex04/ex04.html">
 <span class="dropdown-text">Ex04 · Spatial Weights (Apps)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex05/ex05a.html">
 <span class="dropdown-text">Ex05a · Global Spatial Autocorr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex05/ex05b.html">
 <span class="dropdown-text">Ex05b · Local Spatial Autocorr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex06/ex06.html">
 <span class="dropdown-text">Ex06 · Geospatial Analytics for Social Good</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex07/ex07.html">
 <span class="dropdown-text">Ex07 · Geographically Weighted Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex08/ex08.html">
 <span class="dropdown-text">Ex08 · Geographically Weighted Prediction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex09/ex09.html">
 <span class="dropdown-text">Ex09 · Spatial Accessibility (2SFCA/E2SFCA)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex10/ex10a.html">
 <span class="dropdown-text">Ex10a · Aspatial Spatial Interaction Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_ex10/ex10b.html">
 <span class="dropdown-text">Ex10b · SIM Calibration (spflow)</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-take-home" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Take-home</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-take-home">    
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/take-home_ex01/the01.html">
 <span class="dropdown-text">TH01 · Spatio-temporal Business Registrations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/take-home_ex02/the02.html">
 <span class="dropdown-text">TH02 · Spatio-temporal Bus Passenger Flows</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/take-home_ex03/the03.html">
 <span class="dropdown-text">TH03 · Spatially Informed HDB Resale Price Modelling</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#data-reproducibility" id="toc-data-reproducibility" class="nav-link" data-scroll-target="#data-reproducibility"><span class="header-section-number">2</span> Data &amp; Reproducibility</a>
  <ul>
  <li><a href="#setup-environment" id="toc-setup-environment" class="nav-link" data-scroll-target="#setup-environment"><span class="header-section-number">2.1</span> Setup Environment</a></li>
  <li><a href="#geospatial-data-subzones-bus-stops" id="toc-geospatial-data-subzones-bus-stops" class="nav-link" data-scroll-target="#geospatial-data-subzones-bus-stops"><span class="header-section-number">2.2</span> Geospatial Data: Subzones &amp; Bus Stops</a></li>
  <li><a href="#od-data-download-and-processing" id="toc-od-data-download-and-processing" class="nav-link" data-scroll-target="#od-data-download-and-processing"><span class="header-section-number">2.3</span> OD Data Download and Processing</a></li>
  </ul></li>
  <li><a href="#hexagonal-grid-375-m-apothem" id="toc-hexagonal-grid-375-m-apothem" class="nav-link" data-scroll-target="#hexagonal-grid-375-m-apothem"><span class="header-section-number">3</span> Hexagonal Grid: 375 m (apothem)</a>
  <ul>
  <li><a href="#assign-bus-stops-to-hexagons" id="toc-assign-bus-stops-to-hexagons" class="nav-link" data-scroll-target="#assign-bus-stops-to-hexagons"><span class="header-section-number">3.1</span> Assign Bus Stops to Hexagons</a></li>
  </ul></li>
  <li><a href="#trip-generation-maps-required" id="toc-trip-generation-maps-required" class="nav-link" data-scroll-target="#trip-generation-maps-required"><span class="header-section-number">4</span> Trip Generation Maps (Required)</a>
  <ul>
  <li><a href="#define-time-windows" id="toc-define-time-windows" class="nav-link" data-scroll-target="#define-time-windows"><span class="header-section-number">4.1</span> Define Time Windows</a></li>
  <li><a href="#aggregate-to-hexagon-level" id="toc-aggregate-to-hexagon-level" class="nav-link" data-scroll-target="#aggregate-to-hexagon-level"><span class="header-section-number">4.2</span> Aggregate to Hexagon Level</a></li>
  <li><a href="#three-choropleth-maps" id="toc-three-choropleth-maps" class="nav-link" data-scroll-target="#three-choropleth-maps"><span class="header-section-number">4.3</span> Three Choropleth Maps</a></li>
  </ul></li>
  <li><a href="#local-measures-of-spatial-autocorrelation-lmsa" id="toc-local-measures-of-spatial-autocorrelation-lmsa" class="nav-link" data-scroll-target="#local-measures-of-spatial-autocorrelation-lmsa"><span class="header-section-number">5</span> Local Measures of Spatial Autocorrelation (LMSA)</a>
  <ul>
  <li><a href="#spatial-weights-matrix" id="toc-spatial-weights-matrix" class="nav-link" data-scroll-target="#spatial-weights-matrix"><span class="header-section-number">5.1</span> Spatial Weights Matrix</a></li>
  <li><a href="#local-morans-i" id="toc-local-morans-i" class="nav-link" data-scroll-target="#local-morans-i"><span class="header-section-number">5.2</span> Local Moran’s I</a></li>
  <li><a href="#getis-ord-gi" id="toc-getis-ord-gi" class="nav-link" data-scroll-target="#getis-ord-gi"><span class="header-section-number">5.3</span> Getis-Ord Gi*</a></li>
  <li><a href="#local-gearys-c" id="toc-local-gearys-c" class="nav-link" data-scroll-target="#local-gearys-c"><span class="header-section-number">5.4</span> Local Geary’s C</a></li>
  </ul></li>
  <li><a href="#emerging-hot-spot-analysis-ehsa" id="toc-emerging-hot-spot-analysis-ehsa" class="nav-link" data-scroll-target="#emerging-hot-spot-analysis-ehsa"><span class="header-section-number">6</span> Emerging Hot Spot Analysis (EHSA)</a>
  <ul>
  <li><a href="#calculate-gi-for-each-time-window" id="toc-calculate-gi-for-each-time-window" class="nav-link" data-scroll-target="#calculate-gi-for-each-time-window"><span class="header-section-number">6.1</span> Calculate Gi* for Each Time Window</a></li>
  <li><a href="#mann-kendall-trend-test" id="toc-mann-kendall-trend-test" class="nav-link" data-scroll-target="#mann-kendall-trend-test"><span class="header-section-number">6.2</span> Mann-Kendall Trend Test</a></li>
  <li><a href="#ehsa-visualization" id="toc-ehsa-visualization" class="nav-link" data-scroll-target="#ehsa-visualization"><span class="header-section-number">6.3</span> EHSA Visualization</a></li>
  </ul></li>
  <li><a href="#comparative-analysis" id="toc-comparative-analysis" class="nav-link" data-scroll-target="#comparative-analysis"><span class="header-section-number">7</span> Comparative Analysis</a></li>
  <li><a href="#key-findings-planning-recommendations" id="toc-key-findings-planning-recommendations" class="nav-link" data-scroll-target="#key-findings-planning-recommendations"><span class="header-section-number">8</span> Key Findings &amp; Planning Recommendations</a>
  <ul>
  <li><a href="#spatial-patterns" id="toc-spatial-patterns" class="nav-link" data-scroll-target="#spatial-patterns"><span class="header-section-number">8.1</span> Spatial Patterns</a></li>
  <li><a href="#temporal-dynamics" id="toc-temporal-dynamics" class="nav-link" data-scroll-target="#temporal-dynamics"><span class="header-section-number">8.2</span> Temporal Dynamics</a></li>
  <li><a href="#planning-implications" id="toc-planning-implications" class="nav-link" data-scroll-target="#planning-implications"><span class="header-section-number">8.3</span> Planning Implications</a></li>
  </ul></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info"><span class="header-section-number">9</span> Session Info</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Take-home Exercise 2: Spatio-temporal Analysis of Bus Passenger Flows Using Hexagonal Tessellation</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Huang Pengxin </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 15, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">November 15, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This analysis examines spatial autocorrelation patterns and emerging hot spots in Singapore’s bus passenger flows. Using <strong>375 m hexagonal tessellation</strong> (apothem = 375 m), we apply Local Measures of Spatial Autocorrelation (LMSA)—<strong>Local Moran’s I</strong>, <strong>Local Geary’s C</strong> and <strong>Getis-Ord Gi*</strong>—followed by <strong>Emerging Hot Spot Analysis (EHSA)</strong> to identify spatio-temporal trends across three time windows required in TH02:</p>
<ul>
<li><strong>Weekday AM peak</strong>: 06:00–09:00<br>
</li>
<li><strong>Weekday PM peak</strong>: 17:00–20:00<br>
</li>
<li><strong>Weekend/Holiday</strong>: 11:00–20:00</li>
</ul>
</section>
<section id="data-reproducibility" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data &amp; Reproducibility</h1>
<ul>
<li><strong>OD</strong> (latest month) from <strong>LTA DataMall</strong> (<code>PV/ODBus</code> / <code>PV/BusODVolume</code> API).<br>
</li>
<li><strong>Bus stops</strong> from <strong>LTA Bus Stop (GEOJSON)</strong> on data.gov.sg.</li>
<li><strong>Subzones</strong> from <strong>Master Plan 2019 Subzone Boundary (No Sea)</strong> (GEOJSON).<br>
</li>
<li>CRS: <strong>EPSG:3414 (SVY21 / m)</strong>.</li>
</ul>
<p><strong>Time Window Note</strong>: The analysis uses left-closed, right-open hour intervals: - Weekday AM peak (06-09): includes trips from 06:00:00 to 08:59:59 - Weekday PM peak (17-20): includes trips from 17:00:00 to 19:59:59<br>
- Weekend/Holiday (11-20): includes trips from 11:00:00 to 19:59:59</p>
<section id="setup-environment" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="setup-environment"><span class="header-section-number">2.1</span> Setup Environment</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  tidyverse, lubridate, glue,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  sf, spdep, sfdep,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  tmap, viridis, units,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  httr, jsonlite, zip, readr,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  trend, Kendall, janitor,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  gt, knitr, DT</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># tmap mode</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Folder structure</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"data"</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"data/aspatial"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"data/geospatial"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"figures"</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"data/processed"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="geospatial-data-subzones-bus-stops" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="geospatial-data-subzones-bus-stops"><span class="header-section-number">2.2</span> Geospatial Data: Subzones &amp; Bus Stops</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Subzones (GEOJSON)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>subzone_path <span class="ot">&lt;-</span> <span class="st">"data/geospatial/MasterPlan2019SubzoneBoundaryNoSeaGEOJSON.geojson"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(subzone_path)) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  mpsz <span class="ot">&lt;-</span> <span class="fu">st_read</span>(subzone_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">3414</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_make_valid</span>()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Subzone GEOJSON not found at: "</span>, subzone_path)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>sg_boundary <span class="ot">&lt;-</span> mpsz <span class="sc">%&gt;%</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_union</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_make_valid</span>()</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Bus Stops - use local file</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>bus_geojson <span class="ot">&lt;-</span> <span class="st">"data/geospatial/LTABusStop.geojson"</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(bus_geojson)) {</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Reading bus stops from local GEOJSON..."</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  bus_stops <span class="ot">&lt;-</span> <span class="fu">st_read</span>(bus_geojson, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">3414</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardize column name</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">"BUS_STOP_NUM"</span> <span class="sc">%in%</span> <span class="fu">names</span>(bus_stops)) {</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    bus_stops <span class="ot">&lt;-</span> bus_stops <span class="sc">%&gt;%</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">BUS_STOP_CODE =</span> <span class="fu">as.character</span>(BUS_STOP_NUM)) <span class="sc">%&gt;%</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(BUS_STOP_CODE, geometry)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="st">"BUS_STOP_N"</span> <span class="sc">%in%</span> <span class="fu">names</span>(bus_stops)) {</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    bus_stops <span class="ot">&lt;-</span> bus_stops <span class="sc">%&gt;%</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">BUS_STOP_CODE =</span> <span class="fu">as.character</span>(BUS_STOP_N)) <span class="sc">%&gt;%</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(BUS_STOP_CODE, geometry)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Bus stop GEOJSON not found at: "</span>, bus_geojson)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Spatial data loaded:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatial data loaded:</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Subzone polygons:"</span>, <span class="fu">nrow</span>(mpsz), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>- Subzone polygons: 332 </code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Unique bus stops:"</span>, <span class="fu">nrow</span>(bus_stops), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>- Unique bus stops: 5166 </code></pre>
</div>
</div>
</section>
<section id="od-data-download-and-processing" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="od-data-download-and-processing"><span class="header-section-number">2.3</span> OD Data Download and Processing</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>od_dir <span class="ot">&lt;-</span> <span class="st">"data/aspatial"</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(od_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read API key from environment (SET THIS IN ~/.Renviron)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>LTA_KEY <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"LTA_DATAMALL_KEY"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(LTA_KEY <span class="sc">==</span> <span class="st">""</span>) {</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Temporary fallback - REMOVE BEFORE PUBLISHING!</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  LTA_KEY <span class="ot">&lt;-</span> <span class="st">"Lu0AzZeBS5uGe5uQNihkWA=="</span>  </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"Using hardcoded API key. Set LTA_DATAMALL_KEY in ~/.Renviron for security!"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>dm_get <span class="ot">&lt;-</span> <span class="cf">function</span>(url, <span class="at">query =</span> <span class="fu">list</span>(), <span class="at">key =</span> LTA_KEY) {</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> httr<span class="sc">::</span><span class="fu">GET</span>(url, <span class="at">query =</span> query,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                   httr<span class="sc">::</span><span class="fu">add_headers</span>(<span class="at">AccountKey =</span> key, <span class="at">Accept =</span> <span class="st">"application/json"</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>                   httr<span class="sc">::</span><span class="fu">timeout</span>(<span class="dv">60</span>))</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (httr<span class="sc">::</span><span class="fu">status_code</span>(res) <span class="sc">!=</span> <span class="dv">200</span>) <span class="fu">stop</span>(<span class="st">"DataMall GET failed: "</span>, url, <span class="st">" | HTTP "</span>, httr<span class="sc">::</span><span class="fu">status_code</span>(res))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(httr<span class="sc">::</span><span class="fu">content</span>(res, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>), <span class="at">simplifyDataFrame =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>download_od_latest <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">out_dir =</span> od_dir) {</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try PV/ODBus first (returns ZIP link)</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  link <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">try</span>({</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">dm_get</span>(<span class="st">"https://datamall2.mytransport.sg/ltaodataservice/PV/ODBus"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    cand <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Link"</span>,<span class="st">"link"</span>,<span class="st">"URL"</span>,<span class="st">"Url"</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> cand) <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(z[[c]])) { link <span class="ot">&lt;-</span> z[[c]]; <span class="cf">break</span> }</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(link) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(z<span class="sc">$</span>value) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(z<span class="sc">$</span>value)<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(z<span class="sc">$</span>value<span class="sc">$</span>Link)) </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>      link <span class="ot">&lt;-</span> z<span class="sc">$</span>value<span class="sc">$</span>Link[<span class="dv">1</span>]</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(link) <span class="sc">&amp;&amp;</span> <span class="fu">nzchar</span>(link)) {</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Found OD ZIP link: "</span>, link)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    zipfile <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"od_latest.zip"</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    utils<span class="sc">::</span><span class="fu">download.file</span>(link, <span class="at">destfile =</span> zipfile, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    utils<span class="sc">::</span><span class="fu">unzip</span>(zipfile, <span class="at">exdir =</span> out_dir)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlink</span>(zipfile)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    csvs <span class="ot">&lt;-</span> <span class="fu">list.files</span>(out_dir, <span class="at">pattern =</span> <span class="st">"(?i)origin.*destination.*bus.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(csvs) <span class="sc">==</span> <span class="dv">0</span>) csvs <span class="ot">&lt;-</span> <span class="fu">list.files</span>(out_dir, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="st">"No CSV found in OD ZIP."</span> <span class="ot">=</span> <span class="fu">length</span>(csvs) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(csvs[<span class="dv">1</span>])</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fallback: PV/BusODVolume (paged JSON)</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Falling back to PV/BusODVolume (paged JSON)..."</span>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  all <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  skip <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">dm_get</span>(<span class="st">"https://datamall2.mytransport.sg/ltaodataservice/PV/BusODVolume"</span>,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                  <span class="at">query =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">$skip</span><span class="st">`</span> <span class="ot">=</span> skip))</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    v <span class="ot">&lt;-</span> dat<span class="sc">$</span>value</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(v) <span class="sc">||</span> <span class="fu">nrow</span>(v) <span class="sc">==</span> <span class="dv">0</span>) <span class="cf">break</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    all[[<span class="fu">length</span>(all)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> v</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    skip <span class="ot">&lt;-</span> skip <span class="sc">+</span> <span class="fu">nrow</span>(v)</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(v) <span class="sc">&lt;</span> <span class="dv">500</span>) <span class="cf">break</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fl">0.25</span>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>  od_raw <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(all)</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="st">"OD API returned empty."</span> <span class="ot">=</span> <span class="fu">nrow</span>(od_raw) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>  od_std <span class="ot">&lt;-</span> janitor<span class="sc">::</span><span class="fu">clean_names</span>(od_raw)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardize column names</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  ren <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">ORIGIN_PT_CODE =</span> <span class="fu">c</span>(<span class="st">"origin_pt_code"</span>,<span class="st">"originbusstopcode"</span>,<span class="st">"origin_bus_stop_code"</span>),</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">DESTINATION_PT_CODE =</span> <span class="fu">c</span>(<span class="st">"destination_pt_code"</span>,<span class="st">"destinationbusstopcode"</span>,<span class="st">"destination_bus_stop_code"</span>),</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAY_TYPE =</span> <span class="fu">c</span>(<span class="st">"day_type"</span>,<span class="st">"daytype"</span>),</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">TIME_PER_HOUR =</span> <span class="fu">c</span>(<span class="st">"time_per_hour"</span>,<span class="st">"timeperiod"</span>,<span class="st">"hour"</span>),</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_TRIPS =</span> <span class="fu">c</span>(<span class="st">"total_trips"</span>,<span class="st">"pt_trips"</span>,<span class="st">"trips"</span>,<span class="st">"volume"</span>)</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (std <span class="cf">in</span> <span class="fu">names</span>(ren)) {</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    hit <span class="ot">&lt;-</span> <span class="fu">intersect</span>(ren[[std]], <span class="fu">names</span>(od_std))</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(hit) <span class="sc">&gt;</span> <span class="dv">0</span>) od_std <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(od_std, <span class="sc">!!</span><span class="at">std :=</span> dplyr<span class="sc">::</span><span class="fu">all_of</span>(hit[<span class="dv">1</span>]))</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>  out_csv <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"od_bus_latest.csv"</span>)</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(od_std, out_csv)</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out_csv)</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if we have recent OD data</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>od_file <span class="ot">&lt;-</span> <span class="st">"data/aspatial/od_bus_latest.csv"</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(od_file)) {</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>  file_age <span class="ot">&lt;-</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), <span class="fu">file.info</span>(od_file)<span class="sc">$</span>mtime, <span class="at">units =</span> <span class="st">"days"</span>)</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(file_age <span class="sc">&gt;</span> <span class="dv">7</span>) {</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"OD data is "</span>, <span class="fu">round</span>(file_age), <span class="st">" days old. Downloading fresh data..."</span>)</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    od_csv <span class="ot">&lt;-</span> <span class="fu">download_od_latest</span>()</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Using existing OD data ("</span>, <span class="fu">round</span>(file_age), <span class="st">" days old)"</span>)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    od_csv <span class="ot">&lt;-</span> od_file</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No OD data found. Downloading from DataMall..."</span>)</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>  od_csv <span class="ot">&lt;-</span> <span class="fu">download_od_latest</span>()</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>od_data <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(od_csv, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(od_data) <span class="ot">&lt;-</span> <span class="fu">toupper</span>(<span class="fu">names</span>(od_data))</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Type conversions</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>od_data <span class="ot">&lt;-</span> od_data <span class="sc">%&gt;%</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">ORIGIN_PT_CODE =</span> <span class="fu">as.character</span>(ORIGIN_PT_CODE),</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">DESTINATION_PT_CODE =</span> <span class="fu">as.character</span>(DESTINATION_PT_CODE),</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAY_TYPE =</span> <span class="fu">as.character</span>(DAY_TYPE),</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">TIME_PER_HOUR =</span> <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, <span class="fu">as.integer</span>(TIME_PER_HOUR)),</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_TRIPS =</span> <span class="fu">as.numeric</span>(TOTAL_TRIPS)</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"OD loaded:"</span>, <span class="fu">nrow</span>(od_data), <span class="st">"rows from DataMall</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>OD loaded: 10000 rows from DataMall</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Date range in data:"</span>, <span class="fu">paste</span>(<span class="fu">unique</span>(od_data<span class="sc">$</span>DAY_TYPE), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date range in data: WEEKDAY, WEEKENDS/HOLIDAY </code></pre>
</div>
</div>
</section>
</section>
<section id="hexagonal-grid-375-m-apothem" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Hexagonal Grid: 375 m (apothem)</h1>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate hexagons: apothem = 375 m -&gt; flat-to-flat width ~= 750 m</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>hex_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(sg_boundary, <span class="at">cellsize =</span> <span class="dv">750</span>, <span class="at">square =</span> <span class="cn">FALSE</span>, <span class="at">what =</span> <span class="st">"polygons"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sf</span>(<span class="at">geometry =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(sg_boundary) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hex_id =</span> <span class="fu">row_number</span>(),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">area_m2 =</span> <span class="fu">as.numeric</span>(<span class="fu">st_area</span>(geometry))) <span class="sc">%&gt;%</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(area_m2 <span class="sc">&gt;</span> <span class="fl">1e4</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity check</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>expected_area <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">3</span>)<span class="sc">*</span>(<span class="dv">375</span><span class="sc">^</span><span class="dv">2</span>)  <span class="co"># ≈ 486,000 m²</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Hex grid created. n ="</span>, <span class="fu">nrow</span>(hex_grid),</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"| mean area ="</span>, <span class="fu">round</span>(<span class="fu">mean</span>(hex_grid<span class="sc">$</span>area_m2)), <span class="st">"m²"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"| expected ≈"</span>, <span class="fu">round</span>(expected_area), <span class="st">"m²</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Hex grid created. n = 1887 | mean area = 415775 m² | expected ≈ 487139 m²</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visual check</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(hex_grid) <span class="sc">+</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha=</span><span class="fl">0.6</span>, <span class="at">col =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(bus_stops) <span class="sc">+</span> </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_dots</span>(<span class="at">size=</span><span class="fl">0.01</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">alpha=</span><span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"375m (apothem) Hex Grid with Bus Stops"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="the02_files/figure-html/hexgrid-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<section id="assign-bus-stops-to-hexagons" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="assign-bus-stops-to-hexagons"><span class="header-section-number">3.1</span> Assign Bus Stops to Hexagons</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>bus_hex <span class="ot">&lt;-</span> <span class="fu">st_join</span>(bus_stops, hex_grid, <span class="at">join =</span> st_within) <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BUS_STOP_CODE, hex_id) <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(hex_id))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>hex_stop_count <span class="ot">&lt;-</span> bus_hex <span class="sc">%&gt;%</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(hex_id, <span class="at">name =</span> <span class="st">"n_stops"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_stops))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Bus stops assigned to hexagons: "</span>, <span class="fu">nrow</span>(bus_hex), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Bus stops assigned to hexagons:  5161 </code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hex_stop_count, <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Top 5 hexagons by bus stop count"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Top 5 hexagons by bus stop count</caption>
<thead>
<tr class="header">
<th style="text-align: right;">hex_id</th>
<th style="text-align: right;">n_stops</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">356</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: right;">1255</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1003</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: right;">1607</td>
<td style="text-align: right;">18</td>
</tr>
<tr class="odd">
<td style="text-align: right;">662</td>
<td style="text-align: right;">17</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="trip-generation-maps-required" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Trip Generation Maps (Required)</h1>
<section id="define-time-windows" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="define-time-windows"><span class="header-section-number">4.1</span> Define Time Windows</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>time_windows <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Weekday AM peak (06-09)"</span> <span class="ot">=</span> <span class="fu">list</span>(<span class="at">day=</span><span class="st">"WEEKDAY"</span>, <span class="at">hours=</span><span class="fu">sprintf</span>(<span class="st">"%02d"</span>, <span class="dv">6</span><span class="sc">:</span><span class="dv">8</span>)),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Weekday PM peak (17-20)"</span> <span class="ot">=</span> <span class="fu">list</span>(<span class="at">day=</span><span class="st">"WEEKDAY"</span>, <span class="at">hours=</span><span class="fu">sprintf</span>(<span class="st">"%02d"</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>)),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Weekend/Holiday (11-20)"</span> <span class="ot">=</span> <span class="fu">list</span>(<span class="at">day=</span><span class="st">"WEEKENDS/HOLIDAY"</span>, <span class="at">hours=</span><span class="fu">sprintf</span>(<span class="st">"%02d"</span>, <span class="dv">11</span><span class="sc">:</span><span class="dv">19</span>))</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="aggregate-to-hexagon-level" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="aggregate-to-hexagon-level"><span class="header-section-number">4.2</span> Aggregate to Hexagon Level</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>process_window <span class="ot">&lt;-</span> <span class="cf">function</span>(win_name, cfg) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  od_f <span class="ot">&lt;-</span> od_data <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(DAY_TYPE <span class="sc">==</span> cfg<span class="sc">$</span>day,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>           TIME_PER_HOUR <span class="sc">%in%</span> cfg<span class="sc">$</span>hours) <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ORIGIN_PT_CODE) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">trips =</span> <span class="fu">sum</span>(TOTAL_TRIPS, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">.groups=</span><span class="st">"drop"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  od_hex <span class="ot">&lt;-</span> od_f <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(bus_hex, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ORIGIN_PT_CODE"</span><span class="ot">=</span><span class="st">"BUS_STOP_CODE"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(hex_id) <span class="sc">%&gt;%</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">outflow =</span> <span class="fu">sum</span>(trips), <span class="at">.groups=</span><span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">period =</span> win_name)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(od_hex)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>flows_all <span class="ot">&lt;-</span> <span class="fu">map2_df</span>(<span class="fu">names</span>(time_windows), time_windows, process_window)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>flows_sf <span class="ot">&lt;-</span> hex_grid <span class="sc">%&gt;%</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(flows_all, <span class="at">by =</span> <span class="st">"hex_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">outflow =</span> <span class="fu">replace_na</span>(outflow, <span class="dv">0</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="three-choropleth-maps" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="three-choropleth-maps"><span class="header-section-number">4.3</span> Three Choropleth Maps</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw maps for each period</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>draw_flow_map <span class="ot">&lt;-</span> <span class="cf">function</span>(df, period_name) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(period <span class="sc">==</span> period_name)) <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">"outflow"</span>, </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">style =</span> <span class="st">"quantile"</span>, </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> <span class="dv">7</span>, </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">palette =</span> <span class="st">"YlOrRd"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"Origin trips"</span>) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">main.title =</span> period_name, </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">frame =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">draw_flow_map</span>(flows_sf, <span class="st">"Weekday AM peak (06-09)"</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">draw_flow_map</span>(flows_sf, <span class="st">"Weekday PM peak (17-20)"</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">draw_flow_map</span>(flows_sf, <span class="st">"Weekend/Holiday (11-20)"</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_arrange</span>(m1, m2, m3, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="the02_files/figure-html/trip-maps-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p><strong>Weekday AM Peak Commentary</strong>: The morning peak shows high concentration of trip origins in residential areas, particularly in mature estates like Tampines, Jurong West, and Woodlands. CBD and industrial areas show relatively lower origin flows, consistent with commuting patterns where people travel from homes to workplaces. The spatial distribution reveals clear clustering in HDB towns, suggesting strong demand for first-mile connectivity to MRT stations and bus interchanges during morning rush hours.</p>
<p><strong>Weekday PM Peak Commentary</strong>: Evening peak displays a reversed pattern with high origin flows from employment centers including CBD, one-north, and industrial estates. This reflects the return journey from work to residential areas, though the intensity is more dispersed than morning peak. Notable hotspots appear around Raffles Place, Tanjong Pagar, and Jurong Industrial Estate, indicating concentrated workforce distribution requiring enhanced evening services.</p>
<p><strong>Weekend/Holiday Commentary</strong>: Weekend patterns show more evenly distributed flows with hotspots at transportation hubs and shopping districts. The extended time window (11-20) captures leisure and shopping trips, with notable activity around Orchard, Marina Bay, and regional centers like Jurong East and Tampines. The distribution suggests polycentric travel patterns focused on retail and recreational destinations rather than work-related commuting.</p>
</section>
</section>
<section id="local-measures-of-spatial-autocorrelation-lmsa" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Local Measures of Spatial Autocorrelation (LMSA)</h1>
<section id="spatial-weights-matrix" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="spatial-weights-matrix"><span class="header-section-number">5.1</span> Spatial Weights Matrix</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Focus on Weekday AM peak</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>am_sf <span class="ot">&lt;-</span> flows_sf <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(period <span class="sc">==</span> <span class="st">"Weekday AM peak (06-09)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_outflow =</span> <span class="fu">log1p</span>(outflow))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>nb_q <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(am_sf, <span class="at">queen =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>lw_q <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(nb_q, <span class="at">style =</span> <span class="st">"W"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>conn <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Metric =</span> <span class="fu">c</span>(<span class="st">"Average neighbors"</span>, <span class="st">"Min neighbors"</span>, <span class="st">"Max neighbors"</span>, <span class="st">"Isolated units"</span>),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Value =</span> <span class="fu">c</span>(<span class="fu">mean</span>(<span class="fu">card</span>(nb_q)), <span class="fu">min</span>(<span class="fu">card</span>(nb_q)), <span class="fu">max</span>(<span class="fu">card</span>(nb_q)), <span class="fu">sum</span>(<span class="fu">card</span>(nb_q) <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(conn, <span class="at">caption =</span> <span class="st">"Spatial Connectivity Summary"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Spatial Connectivity Summary</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: right;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Average neighbors</td>
<td style="text-align: right;">4.544218</td>
</tr>
<tr class="even">
<td style="text-align: left;">Min neighbors</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Max neighbors</td>
<td style="text-align: right;">6.000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Isolated units</td>
<td style="text-align: right;">9.000000</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="local-morans-i" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="local-morans-i"><span class="header-section-number">5.2</span> Local Moran’s I</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>lisa <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(am_sf<span class="sc">$</span>log_outflow, lw_q, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>am_sf <span class="ot">&lt;-</span> am_sf <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lisa_I =</span> lisa[,<span class="dv">1</span>],</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lisa_p =</span> lisa[,<span class="dv">5</span>],</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag_out =</span> <span class="fu">lag.listw</span>(lw_q, log_outflow, <span class="at">zero.policy=</span><span class="cn">TRUE</span>),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_lo =</span> <span class="fu">mean</span>(log_outflow),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lisa_quad =</span> <span class="fu">case_when</span>(</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>      lisa_p <span class="sc">&gt;=</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"Not Significant"</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      log_outflow <span class="sc">&gt;</span> mean_lo <span class="sc">&amp;</span> lag_out <span class="sc">&gt;</span> mean_lo <span class="sc">~</span> <span class="st">"High-High"</span>,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>      log_outflow <span class="sc">&lt;</span> mean_lo <span class="sc">&amp;</span> lag_out <span class="sc">&lt;</span> mean_lo <span class="sc">~</span> <span class="st">"Low-Low"</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      log_outflow <span class="sc">&gt;</span> mean_lo <span class="sc">&amp;</span> lag_out <span class="sc">&lt;</span> mean_lo <span class="sc">~</span> <span class="st">"High-Low"</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Low-High"</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(am_sf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(lisa_p <span class="sc">&lt;</span> <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"lisa_quad"</span>,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"High-High"</span><span class="ot">=</span><span class="st">"#d7191c"</span>, <span class="st">"High-Low"</span><span class="ot">=</span><span class="st">"#fdae61"</span>,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Low-High"</span><span class="ot">=</span><span class="st">"#abd9e9"</span>, <span class="st">"Low-Low"</span><span class="ot">=</span><span class="st">"#2c7bb6"</span>),</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">"LISA Clusters"</span>) <span class="sc">+</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Local Moran's I (p &lt; 0.05)"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="the02_files/figure-html/lisa-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="getis-ord-gi" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="getis-ord-gi"><span class="header-section-number">5.3</span> Getis-Ord Gi*</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>gi <span class="ot">&lt;-</span> <span class="fu">localG</span>(am_sf<span class="sc">$</span>log_outflow, lw_q, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>am_sf <span class="ot">&lt;-</span> am_sf <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">gi =</span> <span class="fu">as.numeric</span>(gi),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">gi_p =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(gi), <span class="at">lower.tail =</span> <span class="cn">FALSE</span>),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">hotspot =</span> <span class="fu">case_when</span>(</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>      gi_p <span class="sc">&gt;=</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"Not Significant"</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>      gi <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Hot Spot"</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Cold Spot"</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(am_sf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gi_p <span class="sc">&lt;</span> <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"gi"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">palette =</span> <span class="st">"-RdBu"</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">"Gi* z-score"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">style =</span> <span class="st">"cont"</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">midpoint =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Getis-Ord Gi* (p &lt; 0.05)"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="the02_files/figure-html/gist-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="local-gearys-c" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="local-gearys-c"><span class="header-section-number">5.4</span> Local Geary’s C</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using spdep::localC for Local Geary's C</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>geary_c <span class="ot">&lt;-</span> spdep<span class="sc">::</span><span class="fu">localC</span>(am_sf<span class="sc">$</span>log_outflow, lw_q)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>am_sf <span class="ot">&lt;-</span> am_sf <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">geary_c =</span> <span class="fu">as.numeric</span>(geary_c),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">geary_cat =</span> <span class="fu">case_when</span>(</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>      geary_c <span class="sc">&lt;</span> <span class="fl">0.5</span> <span class="sc">~</span> <span class="st">"Positive autocorrelation"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>      geary_c <span class="sc">&gt;</span> <span class="fl">1.5</span> <span class="sc">~</span> <span class="st">"Negative autocorrelation"</span>, </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"No autocorrelation"</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># For significance, use permutation approach</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>nsim <span class="ot">&lt;-</span> <span class="dv">499</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>geary_sim <span class="ot">&lt;-</span> <span class="fu">replicate</span>(nsim, {</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  spdep<span class="sc">::</span><span class="fu">localC</span>(<span class="fu">sample</span>(am_sf<span class="sc">$</span>log_outflow), lw_q)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate p-values</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>geary_p <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(geary_c), <span class="cf">function</span>(i) {</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">abs</span>(geary_sim[i,]) <span class="sc">&gt;=</span> <span class="fu">abs</span>(geary_c[i])) <span class="sc">/</span> nsim</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>am_sf<span class="sc">$</span>geary_p <span class="ot">&lt;-</span> geary_p</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Map only significant results</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(am_sf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(geary_p <span class="sc">&lt;</span> <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"geary_c"</span>, </span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">palette =</span> <span class="st">"RdBu"</span>, </span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>          <span class="at">midpoint =</span> <span class="dv">1</span>,</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">"Local Geary's C"</span>,</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">style =</span> <span class="st">"cont"</span>) <span class="sc">+</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Local Geary's C (p &lt; 0.05)"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="the02_files/figure-html/geary-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="emerging-hot-spot-analysis-ehsa" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Emerging Hot Spot Analysis (EHSA)</h1>
<section id="calculate-gi-for-each-time-window" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="calculate-gi-for-each-time-window"><span class="header-section-number">6.1</span> Calculate Gi* for Each Time Window</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>calc_gi_for <span class="ot">&lt;-</span> <span class="cf">function</span>(period_name, <span class="at">base_sf =</span> hex_grid) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> flows_all <span class="sc">%&gt;%</span> <span class="fu">filter</span>(period <span class="sc">==</span> period_name)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  sfp <span class="ot">&lt;-</span> base_sf <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(dat, <span class="at">by =</span> <span class="st">"hex_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">outflow =</span> <span class="fu">replace_na</span>(outflow, <span class="dv">0</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">log_outflow =</span> <span class="fu">log1p</span>(outflow))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(sfp, <span class="at">queen =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  lw <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(nb, <span class="at">style =</span> <span class="st">"W"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  gi <span class="ot">&lt;-</span> <span class="fu">localG</span>(sfp<span class="sc">$</span>log_outflow, lw, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">hex_id =</span> sfp<span class="sc">$</span>hex_id,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">period =</span> period_name,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">gi =</span> <span class="fu">as.numeric</span>(gi))</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>gi_ts <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calc_gi_for</span>(<span class="st">"Weekday AM peak (06-09)"</span>),</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calc_gi_for</span>(<span class="st">"Weekday PM peak (17-20)"</span>),</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calc_gi_for</span>(<span class="st">"Weekend/Holiday (11-20)"</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>gi_wide <span class="ot">&lt;-</span> gi_ts <span class="sc">%&gt;%</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> period, <span class="at">values_from =</span> gi)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="mann-kendall-trend-test" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="mann-kendall-trend-test"><span class="header-section-number">6.2</span> Mann-Kendall Trend Test</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary without NA</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>ehsa_summary <span class="ot">&lt;-</span> ehsa <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ehsa)) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(ehsa) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentage =</span> <span class="fu">round</span>(n<span class="sc">/</span><span class="fu">sum</span>(n)<span class="sc">*</span><span class="dv">100</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(ehsa_summary, </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"EHSA Pattern Distribution"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Pattern"</span>, <span class="st">"Count"</span>, <span class="st">"Percentage"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>EHSA Pattern Distribution</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Pattern</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">No Trend</td>
<td style="text-align: right;">1885</td>
<td style="text-align: right;">99.89</td>
</tr>
<tr class="even">
<td style="text-align: left;">Insufficient Data</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.11</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="ehsa-visualization" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="ehsa-visualization"><span class="header-section-number">6.3</span> EHSA Visualization</h2>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pal_ehsa <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New Hot Spot"</span> <span class="ot">=</span> <span class="st">"#d73027"</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Intensifying Hot Spot"</span> <span class="ot">=</span> <span class="st">"#fc8d59"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Diminishing Hot Spot"</span> <span class="ot">=</span> <span class="st">"#fee08b"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Diminishing Cold Spot"</span> <span class="ot">=</span> <span class="st">"#91bfdb"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"No Trend"</span> <span class="ot">=</span> <span class="st">"#f0f0f0"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Insufficient Data"</span> <span class="ot">=</span> <span class="st">"#ffffff"</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if there are any significant results</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>sig_ehsa <span class="ot">&lt;-</span> ehsa_sf <span class="sc">%&gt;%</span> </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(p) <span class="sc">&amp;</span> p <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(sig_ehsa) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map significant results</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(sig_ehsa) <span class="sc">+</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">"ehsa"</span>, </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">palette =</span> pal_ehsa, </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"EHSA Classification"</span>) <span class="sc">+</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Emerging Hot Spot Analysis (MK p &lt; 0.05)"</span>, </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">frame =</span> <span class="cn">FALSE</span>,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If no significant results, show all data with note</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(ehsa_sf) <span class="sc">+</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_fill</span>(<span class="st">"ehsa"</span>, </span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">palette =</span> pal_ehsa, </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">"EHSA Classification"</span>) <span class="sc">+</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Emerging Hot Spot Analysis (All Hexagons)</span><span class="sc">\n</span><span class="st">Note: No significant trends detected (p &lt; 0.05)"</span>, </span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>              <span class="at">frame =</span> <span class="cn">FALSE</span>,</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>              <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"bottom"</span>))</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="the02_files/figure-html/ehsa-map-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional summary of significance</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>sig_summary <span class="ot">&lt;-</span> ehsa <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">significant =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(p) <span class="sc">&amp;</span> p <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"Significant"</span>, <span class="st">"Not Significant"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(significant)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(sig_summary, </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Statistical Significance Summary"</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Significance"</span>, <span class="st">"Count"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Statistical Significance Summary</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Significance</th>
<th style="text-align: right;">Count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Not Significant</td>
<td style="text-align: right;">1887</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="comparative-analysis" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Comparative Analysis</h1>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>map_lisa <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(am_sf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(lisa_p <span class="sc">&lt;</span> <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"lisa_quad"</span>, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"High-High"</span><span class="ot">=</span><span class="st">"#d7191c"</span>,<span class="st">"High-Low"</span><span class="ot">=</span><span class="st">"#fdae61"</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Low-High"</span><span class="ot">=</span><span class="st">"#abd9e9"</span>,<span class="st">"Low-Low"</span><span class="ot">=</span><span class="st">"#2c7bb6"</span>),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Local Moran's I"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>map_gi <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(am_sf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gi_p <span class="sc">&lt;</span> <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"gi"</span>, <span class="at">palette =</span> <span class="st">"-RdBu"</span>, <span class="at">legend.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Getis-Ord Gi*"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>map_geary <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(am_sf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(geary_p <span class="sc">&lt;</span> <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"geary_c"</span>, <span class="at">palette =</span> <span class="st">"RdBu"</span>, <span class="at">legend.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">"Local Geary's C"</span>, <span class="at">frame =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_arrange</span>(map_lisa, map_gi, map_geary, <span class="at">ncol =</span> <span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="the02_files/figure-html/compare-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="key-findings-planning-recommendations" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Key Findings &amp; Planning Recommendations</h1>
<section id="spatial-patterns" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="spatial-patterns"><span class="header-section-number">8.1</span> Spatial Patterns</h2>
<ul>
<li><strong>High-High Clusters</strong>: Concentrated in mature residential estates during AM peak</li>
<li><strong>Hot Spots</strong>: Major transport hubs show persistent high activity</li>
<li><strong>Cold Spots</strong>: Industrial and low-density areas consistently show low passenger flows</li>
</ul>
</section>
<section id="temporal-dynamics" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="temporal-dynamics"><span class="header-section-number">8.2</span> Temporal Dynamics</h2>
<ul>
<li><strong>Intensifying Hot Spots</strong>: Growing demand in regional centers</li>
<li><strong>Diminishing Hot Spots</strong>: Some older town centers showing declining activity</li>
<li><strong>Stable Patterns</strong>: CBD maintains consistent high demand across all periods</li>
</ul>
</section>
<section id="planning-implications" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="planning-implications"><span class="header-section-number">8.3</span> Planning Implications</h2>
<ol type="1">
<li><strong>Service Optimization</strong>: Increase frequency in identified hot spots</li>
<li><strong>Network Planning</strong>: Connect emerging hot spots with express services</li>
<li><strong>Infrastructure</strong>: Upgrade facilities in intensifying hot spots</li>
<li><strong>Review Coverage</strong>: Assess service levels in persistent cold spots</li>
</ol>
</section>
</section>
<section id="session-info" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Session Info</h1>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.0 (2025-04-11 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26100)

Matrix products: default
  LAPACK version 3.12.1

locale:
[1] LC_COLLATE=Chinese (Simplified)_Hong Kong SAR.utf8 
[2] LC_CTYPE=Chinese (Simplified)_Hong Kong SAR.utf8   
[3] LC_MONETARY=Chinese (Simplified)_Hong Kong SAR.utf8
[4] LC_NUMERIC=C                                       
[5] LC_TIME=Chinese (Simplified)_Hong Kong SAR.utf8    

time zone: Asia/Shanghai
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] DT_0.33           knitr_1.50        gt_1.1.0          janitor_2.2.1    
 [5] Kendall_2.2.1     trend_1.1.6       zip_2.3.2         jsonlite_2.0.0   
 [9] httr_1.4.7        units_0.8-7       viridis_0.6.5     viridisLite_0.4.2
[13] tmap_4.2          sfdep_0.2.5       spdep_1.4-1       spData_2.3.4     
[17] sf_1.0-21         glue_1.8.0        lubridate_1.9.4   forcats_1.0.0    
[21] stringr_1.5.1     dplyr_1.1.4       purrr_1.0.4       readr_2.1.5      
[25] tidyr_1.3.1       tibble_3.3.0      ggplot2_4.0.0     tidyverse_2.0.0  

loaded via a namespace (and not attached):
 [1] DBI_1.2.3            deldir_2.0-4         gridExtra_2.3       
 [4] tmaptools_3.3        s2_1.1.7             sandwich_3.1-1      
 [7] logger_0.4.0         rlang_1.1.6          magrittr_2.0.3      
[10] multcomp_1.4-29      snakecase_0.11.1     e1071_1.7-16        
[13] compiler_4.5.0       png_0.1-8            vctrs_0.6.5         
[16] crayon_1.5.3         pkgconfig_2.0.3      wk_0.9.4            
[19] fastmap_1.2.0        lwgeom_0.2-14        leafem_0.2.5        
[22] rmarkdown_2.29       tzdb_0.5.0           spacesXYZ_1.5-1     
[25] bit_4.6.0            xfun_0.52            terra_1.8-60        
[28] LearnBayes_2.15.1    parallel_4.5.0       R6_2.6.1            
[31] stringi_1.8.7        RColorBrewer_1.1-3   boot_1.3-31         
[34] stars_0.6-8          Rcpp_1.0.14          zoo_1.8-14          
[37] base64enc_0.1-3      pacman_0.5.1         splines_4.5.0       
[40] Matrix_1.7-3         igraph_2.1.4         timechange_0.3.0    
[43] tidyselect_1.2.1     rstudioapi_0.17.1    dichromat_2.0-0.1   
[46] abind_1.4-8          yaml_2.3.10          maptiles_0.10.0     
[49] codetools_0.2-20     curl_6.2.2           lattice_0.22-6      
[52] leafsync_0.1.0       withr_3.0.2          S7_0.2.0            
[55] coda_0.19-4.1        evaluate_1.0.3       survival_3.8-3      
[58] proxy_0.4-27         xml2_1.3.8           pillar_1.10.2       
[61] KernSmooth_2.23-26   generics_0.1.3       vroom_1.6.5         
[64] sp_2.2-0             hms_1.1.3            scales_1.4.0        
[67] extraDistr_1.10.0    class_7.3-23         spatialreg_1.4-2    
[70] tools_4.5.0          leaflegend_1.2.1     data.table_1.17.0   
[73] mvtnorm_1.3-3        fs_1.6.6             XML_3.99-0.18       
[76] grid_4.5.0           crosstalk_1.2.1      colorspace_2.1-1    
[79] nlme_3.1-168         cols4all_0.9         raster_3.6-32       
[82] cli_3.6.5            gtable_0.3.6         digest_0.6.37       
[85] classInt_0.4-11      TH.data_1.1-4        htmlwidgets_1.6.4   
[88] farver_2.1.2         htmltools_0.5.8.1    lifecycle_1.0.4     
[91] leaflet_2.2.3        MASS_7.3-65          bit64_4.6.0-1       
[94] microbenchmark_1.5.0</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>